name: CMake on Windows

on:
  push:
    branches: [ "omni" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Clone MSVC600 repository
      run: git clone https://github.com/itsmattkc/MSVC600.git

    - name: Set up VC98 environment
      run: |
        # Set VC98 path relative to the cloned repo
        $VC98_PATH = "${{ github.workspace }}\MSVC600\VC98"
        
        # Add VC98 paths to PATH
        echo "$VC98_PATH\Bin" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        echo "$VC98_PATH\Lib" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        echo "$VC98_PATH\Include" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        echo "$VC98_PATH\Common\tools" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        echo "$VC98_PATH\Common\MSDev98\Bin" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH

        # Set environment variables
        echo "LIB=$VC98_PATH\Lib;$VC98_PATH\MFC\Lib;${{ github.workspace }}\build\vc6" >> $env:GITHUB_ENV
        echo "INCLUDE=$VC98_PATH\ATL\Include;$VC98_PATH\Include;$VC98_PATH\MFC\Include;$VC98_PATH\Include" >> $env:GITHUB_ENV
        echo "CC=$VC98_PATH\Bin\CL.exe" >> $env:GITHUB_ENV
        echo "CXX=$VC98_PATH\Bin\CL.exe" >> $env:GITHUB_ENV
        echo "MSVCDir=$VC98_PATH" >> $env:GITHUB_ENV
        where cl
        where nmake
        cmake --preset vc6


    - name: Verify CL.EXE is working
      run: |
        where cl
        where nmake

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}\\build\\vc6" >> "$GITHUB_OUTPUT"
        echo "msvc600-path=${{ github.workspace }}\\MSVC600" >> "$GITHUB_OUTPUT"

    - name: Configure CMake with vc6 preset
      run: cmake --preset vc6

    - name: Build the project using nmake
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: |
        nmake
        if %errorlevel% neq 0 exit /b %errorlevel%

    - name: Verify build success
      run: |
        if not exist "${{ steps.strings.outputs.build-output-dir }}\\<your_binary_name>" (
          echo "Build failed: <your_binary_name> not found!"
          exit 1
        ) else (
          echo "Build succeeded: <your_binary_name> found!"
        )

    - name: Test
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: ctest -C ${{env.BUILD_TYPE}}
